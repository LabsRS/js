/*!
 * embed-vr-iframe.min.js - VR Window Embedding System (Compressed)
 * Author: Jack Sun
 * Email: 34314687@qq.com
 * License: MIT
 * Original file: embed-vr-iframe.js
 * Build time: 2025-12-16T09:06:31.693Z
 * Compression: ~46.5%
 * All features preserved
 */
(function(){


window.createVRWindow=function(userConfig={}){


const CONFIG=Object.assign({url:"https://www.720yun.com/vr/b0bjtgmkvO8",minWidth:200,maxWidth:640,handleBgColor:"rgba(0, 0, 0, 0.4)",buttonHoverColor:"#ffffff",buttonActiveBg:"rgba(255, 255, 255, 0.2)",aspectRatio:16/9,snapThreshold:50,handleHideDelay:3000,enableSnap:true,
handleText:"☰ VR",

initialPosition:{x:null,y:null},
initialSize:{width:null,height:null},
relativeToElement:null,
positionOffset:{x:0,y:0},
zIndex:1000,
enableLoop:false,
loopInterval:60000,
},userConfig,);


const STORAGE_KEY=`vrWindowPrefs_${btoa(CONFIG.url)}`;
const MIN_WIDTH=CONFIG.minWidth;const MAX_WIDTH=Math.min(CONFIG.maxWidth,window.innerWidth*0.9);const DEFAULT_WIDTH=Math.min(320,MAX_WIDTH);const ASPECT_RATIO=CONFIG.aspectRatio;const HANDLE_HIDE_DELAY=CONFIG.handleHideDelay;
const MAX_Z_INDEX=2147483647;
const MIN_Z_INDEX=1;
function validateZIndex(z){
const num=parseInt(z)||1000;
if(num<MIN_Z_INDEX){console.warn(`z-index ${num} 太小，已调整为最小值 ${MIN_Z_INDEX}`);return MIN_Z_INDEX;}if(num>MAX_Z_INDEX){console.warn(`z-index ${num} 超过最大值，已调整为最大值 ${MAX_Z_INDEX}`);return MAX_Z_INDEX;}return num;}
const safeZIndex=validateZIndex(CONFIG.zIndex);const Z_INDEX={container:safeZIndex,handle:Math.min(safeZIndex+1,MAX_Z_INDEX),shield:Math.min(safeZIndex+100,MAX_Z_INDEX)};


let currentWidth=DEFAULT_WIDTH;let currentHeight=currentWidth/ASPECT_RATIO;let savedLeft="calc(100vw - 340px)";let savedTop="calc(100vh - 200px)";
if(CONFIG.initialSize.width!==null&&typeof CONFIG.initialSize.width==="number"){currentWidth=Math.max(MIN_WIDTH,Math.min(MAX_WIDTH,CONFIG.initialSize.width));}if(CONFIG.initialSize.height!==null&&typeof CONFIG.initialSize.height==="number"){currentHeight=CONFIG.initialSize.height;}else{currentHeight=currentWidth/ASPECT_RATIO;}
function getInitialPosition(customOffset=null){let left=null;let top=null;const offset=customOffset||CONFIG.positionOffset;
try{const saved=JSON.parse(localStorage.getItem(STORAGE_KEY));if(saved&&typeof saved.width==="number"&&!isNaN(saved.left)&&!isNaN(saved.top)){return{left:saved.left+"px",top:saved.top+"px"};}}catch(e){console.warn("Failed to load VR window preferences");}
if(CONFIG.relativeToElement){let element=null;if(typeof CONFIG.relativeToElement==="string"){element=document.querySelector(CONFIG.relativeToElement);console.log("Relative element selector:",CONFIG.relativeToElement);}else if(CONFIG.relativeToElement instanceof Element){element=CONFIG.relativeToElement;console.log("Relative element found:",element);}if(element){const rect=element.getBoundingClientRect();const scrollTop=window.scrollY;const scrollLeft=window.scrollX;
left=rect.right+scrollLeft+offset.x;top=rect.bottom+scrollTop+offset.y;
const maxX=window.innerWidth-currentWidth;const maxY=window.innerHeight-currentHeight;if(left>maxX){
left=rect.left+scrollLeft-currentWidth-offset.x;}if(left<0){
left=Math.min(rect.right+scrollLeft+offset.x,maxX);}if(top>maxY){
top=rect.top+scrollLeft-currentHeight-offset.y;}if(top<0){
top=Math.min(rect.bottom+scrollTop+offset.y,maxY);}
left=Math.max(0,Math.min(left,maxX));top=Math.max(0,Math.min(top,maxY));console.log("Element rect:",rect);console.log("Calculated position relative to element:",{left,top});}else{console.warn("Relative element not found:",CONFIG.relativeToElement);}}

if(CONFIG.relativeToElement&&(left!==null&&top!==null)){
}else{if(CONFIG.initialPosition.x!==null){left=CONFIG.initialPosition.x+offset.x;}if(CONFIG.initialPosition.y!==null){top=CONFIG.initialPosition.y+offset.y;}}
if(left===null||top===null){left="calc(100vw - 340px)";top="calc(100vh - 200px)";}else{left=left+"px";top=top+"px";}return{left,top};}
function updatePosition(newOffset=null){const newPos=getInitialPosition(newOffset);
if(newPos.left.includes('calc')){
const calcValue=newPos.left.match(/calc\((.+)\)/);if(calcValue){const expression=calcValue[1];
if(expression.includes('100vw')){const offset=expression.match(/[-+]?\s*(\d+)px/);if(offset){const value=parseInt(offset[1]);const sign=expression.includes('-')?-1:1;const viewportWidth=window.innerWidth;newPos.left=(viewportWidth+sign*value)+'px';}}}}if(newPos.top.includes('calc')){
const calcValue=newPos.top.match(/calc\((.+)\)/);if(calcValue){const expression=calcValue[1];if(expression.includes('100vh')){const offset=expression.match(/[-+]?\s*(\d+)px/);if(offset){const value=parseInt(offset[1]);const sign=expression.includes('-')?-1:1;const viewportHeight=window.innerHeight;newPos.top=(viewportHeight+sign*value)+'px';}}}}
container.style.left=newPos.left;container.style.top=newPos.top;
saveState();}const initialPos=getInitialPosition();savedLeft=initialPos.left;savedTop=initialPos.top;
const container=document.createElement("div");Object.assign(container.style,{position:"fixed",left:savedLeft,top:savedTop,width:currentWidth+"px",height:currentHeight+"px",zIndex:Z_INDEX.container.toString(),boxShadow:"0 4px 20px rgba(0,0,0,0.3)",borderRadius:"8px",overflow:"hidden",pointerEvents:"auto",willChange:"transform, left, top",backfaceVisibility:"hidden",});
const handle=document.createElement("div");Object.assign(handle.style,{position:"absolute",top:"0",left:"0",width:"100%",height:"30px",background:CONFIG.handleBgColor,cursor:"move",zIndex:Z_INDEX.handle.toString(),display:"grid",gridTemplateColumns:"1fr 1fr 1fr",alignItems:"center",padding:"0 8px",color:"white",fontSize:"12px",userSelect:"none",opacity:"0",pointerEvents:"auto",transition:"opacity 0.2s ease",WebkitTapHighlightColor:"transparent",});const dragText=document.createElement("span");dragText.textContent=CONFIG.handleText;
dragText.style.pointerEvents="none";dragText.style.gridColumn="1";
const closeButton=document.createElement("button");Object.assign(closeButton.style,{background:"transparent",border:"none",color:"white",fontSize:"16px",cursor:"pointer",width:"24px",height:"24px",borderRadius:"4px",opacity:"0.8",transition:"opacity 0.2s, background 0.2s",gridColumn:"3",justifySelf:"center",display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"auto",});closeButton.innerHTML="×";closeButton.addEventListener("mouseenter",()=>{closeButton.style.opacity="1";closeButton.style.color=CONFIG.buttonHoverColor;});closeButton.addEventListener("mouseleave",()=>{closeButton.style.opacity="0.8";closeButton.style.color="white";});closeButton.addEventListener("mousedown",()=>{closeButton.style.background=CONFIG.buttonActiveBg;});closeButton.addEventListener("mouseup",()=>{closeButton.style.background="transparent";});closeButton.addEventListener("click",(e)=>{e.stopPropagation();e.preventDefault();container.remove();shield.remove();localStorage.removeItem(STORAGE_KEY);
if(loopInterval){clearInterval(loopInterval);}});
const fullscreenButton=document.createElement("button");Object.assign(fullscreenButton.style,{background:"transparent",border:"none",color:"white",fontSize:"14px",cursor:"pointer",width:"24px",height:"24px",borderRadius:"4px",opacity:"0.8",transition:"opacity 0.2s, background 0.2s",gridColumn:"2",justifySelf:"center",display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"auto",});fullscreenButton.innerHTML="↗";
function requestFullscreenAPI(element){if(element.requestFullscreen){return element.requestFullscreen();}else if(element.webkitRequestFullscreen){return element.webkitRequestFullscreen();}else if(element.msRequestFullscreen){return element.msRequestFullscreen();}else if(element.mozRequestFullScreen){return element.mozRequestFullScreen();}return null;}fullscreenButton.addEventListener("click",(e)=>{e.stopPropagation();e.preventDefault();
const fullscreenPromise=requestFullscreenAPI(container);if(fullscreenPromise&&fullscreenPromise.then){
fullscreenPromise.catch(()=>{
window.open(CONFIG.url,"_blank");});}else if(requestFullscreenAPI(container)){

}else{
window.open(CONFIG.url,"_blank");}});
[fullscreenButton,closeButton].forEach((btn)=>{btn.addEventListener("mouseenter",()=>{btn.style.opacity="1";btn.style.color=CONFIG.buttonHoverColor;});btn.addEventListener("mouseleave",()=>{btn.style.opacity="0.8";btn.style.color="white";});btn.addEventListener("mousedown",()=>{btn.style.background=CONFIG.buttonActiveBg;});btn.addEventListener("mouseup",()=>{btn.style.background="transparent";});});
handle.appendChild(dragText);
handle.appendChild(fullscreenButton);
handle.appendChild(closeButton);

const iframe=document.createElement("iframe");Object.assign(iframe.style,{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",border:"none",pointerEvents:"auto",});
let loopInterval=null;function setupLoopPlay(customInterval=null){if(loopInterval){clearInterval(loopInterval);loopInterval=null;}if(CONFIG.enableLoop){const interval=customInterval!==null?customInterval:CONFIG.loopInterval;loopInterval=setInterval(()=>{
if(!document.contains(container)){clearInterval(loopInterval);return;}
iframe.src=CONFIG.url;},interval);}}
setTimeout(()=>setupLoopPlay(),2000);iframe.src=CONFIG.url;
const shield=document.createElement("div");Object.assign(shield.style,{position:"fixed",top:"0",left:"0",width:"100vw",height:"100vh",zIndex:Z_INDEX.shield.toString(),display:"none",pointerEvents:"none",});
const resizeHandles={se:document.createElement("div"),
e:document.createElement("div"),
s:document.createElement("div")
};
const resizeHandleStyle={position:"absolute",backgroundColor:"transparent",pointerEvents:"auto",zIndex:(Z_INDEX.handle+1).toString(),opacity:"0",transition:"opacity 0.2s ease"};
Object.assign(resizeHandles.se.style,resizeHandleStyle,{right:"0",bottom:"0",width:"16px",height:"16px",cursor:"se-resize",backgroundImage:"linear-gradient(135deg, transparent 33%, white 33%, white 40%, transparent 40%, transparent 66%, white 66%, white 73%, transparent 73%)"});resizeHandles.se.setAttribute('data-resize-handle','se');
Object.assign(resizeHandles.e.style,resizeHandleStyle,{right:"0",top:"30px",
bottom:"16px",
width:"8px",cursor:"e-resize"});resizeHandles.e.setAttribute('data-resize-handle','e');
Object.assign(resizeHandles.s.style,resizeHandleStyle,{bottom:"0",left:"0",right:"16px",
height:"8px",cursor:"s-resize"});resizeHandles.s.setAttribute('data-resize-handle','s');
container.addEventListener("mouseenter",()=>{Object.values(resizeHandles).forEach(handle=>{handle.style.opacity="0.7";});});container.addEventListener("mouseleave",()=>{Object.values(resizeHandles).forEach(handle=>{handle.style.opacity="0";});});
container.appendChild(handle);container.appendChild(iframe);
Object.values(resizeHandles).forEach(handle=>{container.appendChild(handle);});document.body.appendChild(container);document.body.appendChild(shield);
const isMobile=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent,);let hideTimeout=null;
function showHandle(){handle.style.opacity="1";if(hideTimeout)clearTimeout(hideTimeout);if(isMobile){hideTimeout=setTimeout(()=>{handle.style.opacity="0";},HANDLE_HIDE_DELAY);}}if(!isMobile){container.addEventListener("mouseenter",showHandle);container.addEventListener("mouseleave",()=>{handle.style.opacity="0";});}else{container.addEventListener("touchstart",showHandle,{passive:true});handle.style.opacity="0";}
let isDragging=false;let isPinching=false;let isResizing=false;let resizeDirection="";
let offsetX=0;let offsetY=0;let initialDistance=0;let initialWidth=currentWidth;let initialHeight=currentHeight;let initialX=0;let initialY=0;let containerRect=null;
function getTouchDistance(touches){if(touches.length<2)return 0;const dx=touches[0].clientX-touches[1].clientX;const dy=touches[0].clientY-touches[1].clientY;return Math.sqrt(dx*dx+dy*dy);}function getEventClientXY(e){if(e.type.startsWith("touch")){const touch=e.touches[0]||e.changedTouches[0];return{x:touch.clientX,y:touch.clientY};}else{return{x:e.clientX,y:e.clientY};}}function updateContainerSize(newWidth){newWidth=Math.max(MIN_WIDTH,Math.min(MAX_WIDTH,newWidth));currentWidth=newWidth;currentHeight=newWidth/ASPECT_RATIO;container.style.width=newWidth+"px";container.style.height=currentHeight+"px";}
function snapToEdge(x,y){if(!CONFIG.enableSnap)return{x,y};
const maxX=window.innerWidth-currentWidth;const maxY=window.innerHeight-currentHeight;const threshold=CONFIG.snapThreshold;if(x<threshold)x=0;else if(x>maxX-threshold)x=maxX;if(y<threshold)y=0;else if(y>maxY-threshold)y=maxY;return{x,y};}function saveState(){try{const rect=container.getBoundingClientRect();localStorage.setItem(STORAGE_KEY,JSON.stringify({width:currentWidth,left:rect.left+window.scrollX,top:rect.top+window.scrollY,}),);}catch(e){console.warn("Save state failed");}}function applyPosition(x,y){container.style.left=x+"px";container.style.top=y+"px";container.style.right="auto";container.style.bottom="auto";container.style.transform="none";}
function startInteraction(e){if(e.type==="mousedown"){
const target=e.target;if(target.hasAttribute('data-resize-handle')){return;
}startDrag(e);}else if(e.type==="touchstart"){if(e.touches.length===1){startDrag(e);}else if(e.touches.length===2){startPinch(e);}}}function startDrag(e){e.preventDefault();const rect=container.getBoundingClientRect();const{x,y}=getEventClientXY(e);offsetX=x-rect.left;offsetY=y-rect.top;isDragging=true;activateShield();bindEvents();}function startPinch(e){e.preventDefault();isPinching=true;initialDistance=getTouchDistance(e.touches);initialWidth=currentWidth;activateShield();bindEvents();}function startResize(e,direction){e.preventDefault();e.stopPropagation();isResizing=true;resizeDirection=direction;const{x,y}=getEventClientXY(e);initialX=x;initialY=y;initialWidth=currentWidth;initialHeight=currentHeight;containerRect=container.getBoundingClientRect();activateShield();bindEvents();}function activateShield(){shield.style.display="block";shield.style.pointerEvents="auto";iframe.style.pointerEvents="none";showHandle();}function bindEvents(){shield.addEventListener("mousemove",onDragOrPinch,{passive:false});shield.addEventListener("mouseup",endInteraction,{passive:true});shield.addEventListener("touchmove",onDragOrPinch,{passive:false});shield.addEventListener("touchend",endInteraction,{passive:true});}function onDragOrPinch(e){if(isResizing){onResize(e);}else if(isPinching&&e.touches?.length===2){onPinch(e);}else if(isDragging){onDrag(e);}}function onDrag(e){if(!isDragging)return;e.preventDefault();const{x,y}=getEventClientXY(e);let newX=x-offsetX;let newY=y-offsetY;const maxX=window.innerWidth-currentWidth;const maxY=window.innerHeight-currentHeight;newX=Math.max(0,Math.min(newX,maxX));newY=Math.max(0,Math.min(newY,maxY));applyPosition(newX,newY);}function onPinch(e){if(!isPinching)return;e.preventDefault();const currentDistance=getTouchDistance(e.touches);updateContainerSize(initialWidth*(currentDistance/initialDistance));const rect=container.getBoundingClientRect();const centerX=rect.left+rect.width/2;const centerY=rect.top+rect.height/2;const newLeft=centerX-currentWidth/2;const newTop=centerY-currentHeight/2;applyPosition(Math.max(0,Math.min(window.innerWidth-currentWidth,newLeft)),Math.max(0,Math.min(window.innerHeight-currentHeight,newTop)),);}function onResize(e){if(!isResizing)return;e.preventDefault();e.stopPropagation();const{x,y}=getEventClientXY(e);let newWidth=initialWidth;let newHeight=initialHeight;if(resizeDirection==='se'||resizeDirection==='e'){newWidth=Math.max(MIN_WIDTH,Math.min(MAX_WIDTH,initialWidth+(x-initialX)));}if(resizeDirection==='se'||resizeDirection==='s'){newHeight=newWidth/ASPECT_RATIO;
}updateContainerSize(newWidth);
if(resizeDirection==='se'||resizeDirection==='e'){const rect=container.getBoundingClientRect();const maxX=window.innerWidth-currentWidth;const maxY=window.innerHeight-currentHeight;if(rect.left>maxX){applyPosition(maxX,rect.top);}if(rect.top>maxY){applyPosition(rect.left,maxY);}}}function endInteraction(){const wasDragging=isDragging;const wasResizing=isResizing;isDragging=false;isPinching=false;isResizing=false;resizeDirection="";shield.style.display="none";shield.style.pointerEvents="none";iframe.style.pointerEvents="auto";shield.removeEventListener("mousemove",onDragOrPinch);shield.removeEventListener("mouseup",endInteraction);shield.removeEventListener("touchmove",onDragOrPinch);shield.removeEventListener("touchend",endInteraction);if(wasDragging&&!isPinching&&CONFIG.enableSnap){const rect=container.getBoundingClientRect();const snapped=snapToEdge(rect.left,rect.top);applyPosition(snapped.x,snapped.y);}saveState();if(isMobile){hideTimeout=setTimeout(()=>{handle.style.opacity="0";},HANDLE_HIDE_DELAY);}}function shouldStartDrag(target){return!target.closest("button")&&!target.closest('[data-resize-handle]');}handle.addEventListener("mousedown",(e)=>{if(shouldStartDrag(e.target)){startInteraction(e);}});handle.addEventListener("touchstart",(e)=>{if(shouldStartDrag(e.target)){startInteraction(e);}},{passive:false},);
Object.entries(resizeHandles).forEach(([key,handle])=>{handle.addEventListener("mousedown",(e)=>{e.preventDefault();e.stopPropagation();startResize(e,key);});
handle.addEventListener("click",(e)=>{e.preventDefault();e.stopPropagation();});});
return{container,iframe,close:()=>{if(loopInterval)clearInterval(loopInterval);container.remove();},updateLoop:(enable)=>{CONFIG.enableLoop=enable;setupLoopPlay();},setLoopInterval:(milliseconds)=>{
CONFIG.loopInterval=milliseconds;setupLoopPlay();},getLoopInterval:()=>{
return CONFIG.loopInterval;},
setPositionOffset:(x,y)=>{
CONFIG.positionOffset={x:x||0,y:y||0};updatePosition();},getPositionOffset:()=>{
return{...CONFIG.positionOffset};},adjustPositionOffset:(deltaX=0,deltaY=0)=>{
CONFIG.positionOffset.x+=deltaX;CONFIG.positionOffset.y+=deltaY;updatePosition();},repositionToElement:(element,offset=null)=>{
if(element){CONFIG.relativeToElement=element;if(offset){CONFIG.positionOffset=offset;}updatePosition();}},
setZIndex:(zIndex)=>{
const safeZ=validateZIndex(zIndex);CONFIG.zIndex=safeZ;
Z_INDEX.container=safeZ;Z_INDEX.handle=Math.min(safeZ+1,MAX_Z_INDEX);Z_INDEX.shield=Math.min(safeZ+100,MAX_Z_INDEX);
container.style.zIndex=Z_INDEX.container.toString();handle.style.zIndex=Z_INDEX.handle.toString();shield.style.zIndex=Z_INDEX.shield.toString();console.log('Updated z-index:',Z_INDEX);return Z_INDEX;},getZIndex:()=>{
return{...Z_INDEX};},bringToFront:()=>{
const maxZ=Math.max(...Array.from(document.querySelectorAll('*')).map(el=>parseInt(window.getComputedStyle(el).zIndex)||0).filter(z=>z>0));
let newZ=maxZ+10;if(newZ>MAX_Z_INDEX-100){newZ=MAX_Z_INDEX-100;
console.warn('接近最大z-index值，使用安全值:',newZ);}CONFIG.zIndex=newZ;
Z_INDEX.container=newZ;Z_INDEX.handle=Math.min(newZ+1,MAX_Z_INDEX);Z_INDEX.shield=Math.min(newZ+100,MAX_Z_INDEX);container.style.zIndex=Z_INDEX.container.toString();handle.style.zIndex=Z_INDEX.handle.toString();shield.style.zIndex=Z_INDEX.shield.toString();console.log('Brought to front with z-index:',Z_INDEX.container);return Z_INDEX;},};};})();